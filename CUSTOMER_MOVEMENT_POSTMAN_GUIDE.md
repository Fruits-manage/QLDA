# H∆∞·ªõng d·∫´n ƒëƒÉng k√Ω Customer v√† t·∫°o Stock Movement trong Postman

## üìã Customer Registration (ƒêƒÉng k√Ω kh√°ch h√†ng)

### üéØ Endpoint: T·∫°o Customer m·ªõi
**URL**: `POST http://127.0.0.1:8000/companies/api/create/`

### üìù Headers:
```
Content-Type: application/json
Accept: application/json
```

### üìã Request Body (Kh√°ch h√†ng c∆° b·∫£n):
```json
{
    "name": "C√¥ng ty TNHH Th∆∞∆°ng M·∫°i Tr√°i C√¢y Vi·ªát",
    "company_type": "customer",
    "tax_code": "0987654321",
    "address": "456 ƒê∆∞·ªùng C·ªông H√≤a, Qu·∫≠n T√¢n B√¨nh, TP.HCM",
    "phone": "028-87654321",
    "email": "info@traicayviet.com",
    "website": "https://traicayviet.com",
    "contact_person": "Tr·∫ßn Th·ªã Lan",
    "contact_phone": "0901234567",
    "contact_email": "lan.tran@traicayviet.com",
    "is_active": true
}
```

### üìã Request Body (Kh√°ch h√†ng xu·∫•t kh·∫©u ƒë·∫ßy ƒë·ªß):
```json
{
    "name": "ABC Export Import Company Ltd",
    "company_type": "customer",
    "tax_code": "1234567890",
    "address": "789 Export Street, District 7, Ho Chi Minh City, Vietnam",
    "phone": "+84-28-12345678",
    "email": "export@abccompany.com",
    "website": "https://abcexport.com",
    "contact_person": "John Smith",
    "contact_phone": "+84-905-123-456",
    "contact_email": "john.smith@abccompany.com",
    "bank_name": "HSBC Bank Vietnam",
    "bank_account": "USD-123456789",
    "import_license": "",
    "export_license": "EXPORT-2024-VN-001",
    "is_active": true
}
```

### ‚úÖ Response th√†nh c√¥ng:
```json
{
    "success": true,
    "message": "T·∫°o c√¥ng ty th√†nh c√¥ng",
    "data": {
        "id": 5,
        "name": "ABC Export Import Company Ltd",
        "company_type": "customer",
        "tax_code": "1234567890",
        "address": "789 Export Street, District 7, Ho Chi Minh City, Vietnam",
        "phone": "+84-28-12345678",
        "email": "export@abccompany.com",
        "website": "https://abcexport.com",
        "contact_person": "John Smith",
        "contact_phone": "+84-905-123-456",
        "contact_email": "john.smith@abccompany.com",
        "bank_name": "HSBC Bank Vietnam",
        "bank_account": "USD-123456789",
        "import_license": "",
        "export_license": "EXPORT-2024-VN-001",
        "is_active": true,
        "created_at": "2024-08-09T15:30:00.000Z",
        "updated_at": "2024-08-09T15:30:00.000Z"
    }
}
```

### üîç Ki·ªÉm tra Customer ƒë√£ t·∫°o:
**URL**: `GET http://127.0.0.1:8000/companies/api/list/?type=customer`

---

## üì¶ Stock Movement Creation (T·∫°o phi·∫øu xu·∫•t nh·∫≠p kho)

### üéØ Endpoint: T·∫°o Stock Movement
**URL**: `POST http://127.0.0.1:8000/inventory/movements/api/create/`

### üìù Headers:
```
Content-Type: application/json
Accept: application/json
```

### üìã Request Body (Phi·∫øu nh·∫≠p kho):
```json
{
    "movement_type": "inbound",
    "warehouse_id": 1,
    "reference_number": "IMP-20240809-001",
    "notes": "Nh·∫≠p kho h√†ng m·ªõi t·ª´ nh√† cung c·∫•p",
    "expected_date": "2024-08-10",
    "items": [
        {
            "product_id": 1,
            "quantity": 100.0,
            "unit_cost": 25000.0,
            "notes": "Thanh long ru·ªôt ƒë·ªè, ch·∫•t l∆∞·ª£ng cao"
        },
        {
            "product_id": 2,
            "quantity": 50.0,
            "unit_cost": 45000.0,
            "notes": "Xo√†i c√°t H√≤a L·ªôc"
        }
    ]
}
```

### üìã Request Body (Phi·∫øu xu·∫•t kho):
```json
{
    "movement_type": "outbound",
    "warehouse_id": 1,
    "reference_number": "EXP-20240809-001",
    "notes": "Xu·∫•t kho theo ƒë∆°n h√†ng DO-000001",
    "expected_date": "2024-08-09",
    "order_id": 1,
    "items": [
        {
            "product_id": 1,
            "quantity": 20.0,
            "unit_cost": 25000.0,
            "notes": "Xu·∫•t cho ƒë∆°n h√†ng xu·∫•t kh·∫©u"
        },
        {
            "product_id": 2,
            "quantity": 10.0,
            "unit_cost": 45000.0,
            "notes": "Xu·∫•t cho ƒë∆°n h√†ng xu·∫•t kh·∫©u"
        }
    ]
}
```

### üìã Request Body (ƒêi·ªÅu chuy·ªÉn kho):
```json
{
    "movement_type": "transfer",
    "warehouse_id": 1,
    "destination_warehouse_id": 2,
    "reference_number": "TRF-20240809-001",
    "notes": "ƒêi·ªÅu chuy·ªÉn h√†ng t·ª´ kho ch√≠nh ƒë·∫øn kho ph√¢n ph·ªëi",
    "expected_date": "2024-08-10",
    "items": [
        {
            "product_id": 1,
            "quantity": 15.0,
            "unit_cost": 25000.0,
            "notes": "ƒêi·ªÅu chuy·ªÉn ƒë·ªÉ c√¢n b·∫±ng t·ªìn kho"
        }
    ]
}
```

### ‚úÖ Response th√†nh c√¥ng:
```json
{
    "success": true,
    "message": "T·∫°o phi·∫øu xu·∫•t nh·∫≠p kho th√†nh c√¥ng",
    "data": {
        "id": 12,
        "movement_number": "MOV-20240809-012",
        "movement_type": "inbound",
        "movement_type_display": "Nh·∫≠p kho",
        "warehouse": {
            "id": 1,
            "name": "Kho L·∫°nh Tr√°i C√¢y Qu·∫≠n 7",
            "code": "WH-Q7-001"
        },
        "reference_number": "IMP-20240809-001",
        "notes": "Nh·∫≠p kho h√†ng m·ªõi t·ª´ nh√† cung c·∫•p",
        "status": "pending",
        "expected_date": "2024-08-10",
        "actual_date": null,
        "total_items": 2,
        "total_value": 4750000.0,
        "created_at": "2024-08-09T15:45:00.000Z",
        "items": [
            {
                "id": 23,
                "product": {
                    "id": 1,
                    "name": "Thanh long ru·ªôt ƒë·ªè",
                    "code": "TL001"
                },
                "quantity": 100.0,
                "unit_cost": 25000.0,
                "total_cost": 2500000.0,
                "notes": "Thanh long ru·ªôt ƒë·ªè, ch·∫•t l∆∞·ª£ng cao"
            },
            {
                "id": 24,
                "product": {
                    "id": 2,
                    "name": "Xo√†i c√°t H√≤a L·ªôc",
                    "code": "XM001"
                },
                "quantity": 50.0,
                "unit_cost": 45000.0,
                "total_cost": 2250000.0,
                "notes": "Xo√†i c√°t H√≤a L·ªôc"
            }
        ]
    }
}
```

---

## üîß API cho Stock Movement (C·∫ßn t·∫°o th√™m)

N·∫øu API ch∆∞a c√≥, ƒë√¢y l√† c√°c endpoint c·∫ßn t·∫°o:

### üìå C·∫ßn th√™m v√†o `inventory/views.py`:

```python
@method_decorator(csrf_exempt, name='dispatch')
class StockMovementAPICreateView(View):
    def post(self, request):
        try:
            data = json.loads(request.body)
            
            # Validate required fields
            required_fields = ['movement_type', 'warehouse_id', 'items']
            for field in required_fields:
                if not data.get(field):
                    return JsonResponse({
                        'success': False,
                        'error': f'Tr∆∞·ªùng {field} l√† b·∫Øt bu·ªôc'
                    }, status=400)
            
            # Validate movement_type
            valid_types = ['inbound', 'outbound', 'transfer', 'adjustment']
            if data['movement_type'] not in valid_types:
                return JsonResponse({
                    'success': False,
                    'error': f'Lo·∫°i phi·∫øu kh√¥ng h·ª£p l·ªá. Ch·ªçn t·ª´: {", ".join(valid_types)}'
                }, status=400)
            
            # Check warehouse exists
            try:
                warehouse = Warehouse.objects.get(id=data['warehouse_id'])
            except Warehouse.DoesNotExist:
                return JsonResponse({
                    'success': False,
                    'error': 'Kho kh√¥ng t·ªìn t·∫°i'
                }, status=400)
            
            with transaction.atomic():
                # Create movement
                movement = StockMovement.objects.create(
                    movement_type=data['movement_type'],
                    warehouse=warehouse,
                    reference_number=data.get('reference_number', ''),
                    notes=data.get('notes', ''),
                    expected_date=data.get('expected_date'),
                    created_by_id=1  # Replace with request.user.id
                )
                
                # Generate movement number
                movement.movement_number = f"MOV-{movement.created_at.strftime('%Y%m%d')}-{movement.id:03d}"
                movement.save()
                
                # Create movement items
                total_value = 0
                items_data = []
                
                for item_data in data['items']:
                    try:
                        product = Product.objects.get(id=item_data['product_id'])
                        quantity = float(item_data['quantity'])
                        unit_cost = float(item_data.get('unit_cost', 0))
                        total_cost = quantity * unit_cost
                        
                        # Create movement item (you need this model)
                        # movement_item = StockMovementItem.objects.create(...)
                        
                        total_value += total_cost
                        
                        items_data.append({
                            'product': {
                                'id': product.id,
                                'name': product.name,
                                'code': product.code
                            },
                            'quantity': quantity,
                            'unit_cost': unit_cost,
                            'total_cost': total_cost,
                            'notes': item_data.get('notes', '')
                        })
                        
                    except Product.DoesNotExist:
                        return JsonResponse({
                            'success': False,
                            'error': f'S·∫£n ph·∫©m ID {item_data["product_id"]} kh√¥ng t·ªìn t·∫°i'
                        }, status=400)
                
                return JsonResponse({
                    'success': True,
                    'message': 'T·∫°o phi·∫øu xu·∫•t nh·∫≠p kho th√†nh c√¥ng',
                    'data': {
                        'id': movement.id,
                        'movement_number': movement.movement_number,
                        'movement_type': movement.movement_type,
                        'warehouse': {
                            'id': warehouse.id,
                            'name': warehouse.name,
                            'code': warehouse.code
                        },
                        'reference_number': movement.reference_number,
                        'notes': movement.notes,
                        'status': movement.status,
                        'expected_date': movement.expected_date.isoformat() if movement.expected_date else None,
                        'total_items': len(items_data),
                        'total_value': total_value,
                        'created_at': movement.created_at.isoformat(),
                        'items': items_data
                    }
                })
                
        except json.JSONDecodeError:
            return JsonResponse({
                'success': False,
                'error': 'D·ªØ li·ªáu JSON kh√¥ng h·ª£p l·ªá'
            }, status=400)
        except Exception as e:
            return JsonResponse({
                'success': False,
                'error': f'L·ªói server: {str(e)}'
            }, status=500)
```

### üìå Th√™m URL v√†o `inventory/urls.py`:
```python
path('movements/api/create/', views.StockMovementAPICreateView.as_view(), name='movement_api_create'),
```

---

## üîç Ki·ªÉm tra d·ªØ li·ªáu ƒë√£ t·∫°o

### Customer:
- **List**: `GET http://127.0.0.1:8000/companies/api/list/`
- **Detail**: `GET http://127.0.0.1:8000/companies/api/{id}/`

### Stock Movement:
- **List**: `GET http://127.0.0.1:8000/inventory/movements/`
- **Detail**: `GET http://127.0.0.1:8000/inventory/movements/{id}/`

---

## ‚ùå X·ª≠ l√Ω l·ªói th∆∞·ªùng g·∫∑p

### Customer Creation:
- **Tax code tr√πng**: Thay ƒë·ªïi `tax_code`
- **T√™n c√¥ng ty tr√πng**: Thay ƒë·ªïi `name`
- **Email kh√¥ng h·ª£p l·ªá**: Ki·ªÉm tra format email

### Stock Movement:
- **Warehouse kh√¥ng t·ªìn t·∫°i**: Ki·ªÉm tra `warehouse_id`
- **Product kh√¥ng t·ªìn t·∫°i**: Ki·ªÉm tra `product_id`
- **S·ªë l∆∞·ª£ng √¢m**: Quantity ph·∫£i > 0
- **Movement type kh√¥ng h·ª£p l·ªá**: Ch·ªâ ch·ªçn t·ª´ `inbound`, `outbound`, `transfer`, `adjustment`

---

## üìù L∆∞u √Ω quan tr·ªçng

1. **Customer ID**: L∆∞u l·∫°i ID c·ªßa customer v·ª´a t·∫°o ƒë·ªÉ s·ª≠ d·ª•ng cho orders
2. **Warehouse ID**: C·∫ßn c√≥ warehouse tr∆∞·ªõc khi t·∫°o stock movement
3. **Product ID**: C·∫ßn c√≥ products trong h·ªá th·ªëng tr∆∞·ªõc
4. **Reference Number**: N√™n unique ƒë·ªÉ d·ªÖ theo d√µi
5. **Date Format**: S·ª≠ d·ª•ng YYYY-MM-DD cho dates

**Ch√∫c b·∫°n test API th√†nh c√¥ng!** üéâ
